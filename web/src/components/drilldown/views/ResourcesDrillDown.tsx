import { useMemo } from 'react'
import { useClusters, useGPUNodes } from '../../../hooks/useMCP'
import { useDrillDownActions } from '../../../hooks/useDrillDown'
import { Gauge } from '../../charts/Gauge'
import { Cpu, MemoryStick, Server, ChevronRight } from 'lucide-react'
import { StatusIndicator } from '../../charts/StatusIndicator'

interface Props {
  data: Record<string, unknown>
}

export function ResourcesDrillDown({ data: _data }: Props) {
  const { deduplicatedClusters: clusters, isLoading } = useClusters()
  const { nodes: gpuNodes } = useGPUNodes()
  const { drillToCluster } = useDrillDownActions()

  // Build a map of raw cluster names to deduplicated primary names
  const clusterNameMap = useMemo(() => {
    const map: Record<string, string> = {}
    clusters.forEach(c => {
      map[c.name] = c.name // Primary maps to itself
      c.aliases?.forEach(alias => {
        map[alias] = c.name // Aliases map to primary
      })
    })
    return map
  }, [clusters])

  // Calculate per-cluster GPU data (mapping aliases to primary cluster names)
  // Also deduplicate GPU nodes by name to avoid counting same physical node twice
  const clusterGPUs = useMemo(() => {
    const map: Record<string, { total: number; allocated: number }> = {}
    const seenNodes = new Set<string>() // Track seen node names to avoid duplicates

    gpuNodes.forEach(node => {
      // Skip if we've already counted this physical node
      const nodeKey = node.name
      if (seenNodes.has(nodeKey)) return
      seenNodes.add(nodeKey)

      const rawCluster = node.cluster || 'unknown'
      // Map to deduplicated primary name if possible
      const cluster = clusterNameMap[rawCluster] || rawCluster
      if (!map[cluster]) {
        map[cluster] = { total: 0, allocated: 0 }
      }
      map[cluster].total += node.gpuCount
      map[cluster].allocated += node.gpuAllocated
    })
    return map
  }, [gpuNodes, clusterNameMap])

  // Calculate totals (using deduplicated GPU counts from clusterGPUs map)
  const totals = useMemo(() => {
    const totalCPUs = clusters.reduce((sum, c) => sum + (c.cpuCores || 0), 0)
    const totalCPURequests = clusters.reduce((sum, c) => sum + (c.cpuRequestsCores || 0), 0)
    const totalNodes = clusters.reduce((sum, c) => sum + (c.nodeCount || 0), 0)
    const totalPods = clusters.reduce((sum, c) => sum + (c.podCount || 0), 0)
    const totalMemoryGB = clusters.reduce((sum, c) => sum + (c.memoryGB || 0), 0)
    const totalMemoryRequestsGB = clusters.reduce((sum, c) => sum + (c.memoryRequestsGB || 0), 0)
    // Use aggregated GPU counts from clusterGPUs (already deduplicated)
    let totalGPUs = 0
    let allocatedGPUs = 0
    Object.values(clusterGPUs).forEach(gpu => {
      totalGPUs += gpu.total
      allocatedGPUs += gpu.allocated
    })

    return {
      cpus: totalCPUs,
      cpuRequests: totalCPURequests,
      nodes: totalNodes,
      pods: totalPods,
      memoryGB: totalMemoryGB,
      memoryRequestsGB: totalMemoryRequestsGB,
      gpus: totalGPUs,
      gpusAllocated: allocatedGPUs,
    }
  }, [clusters, clusterGPUs])

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary" />
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* Summary Stats */}
      <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
        <div className="p-4 rounded-lg bg-card/50 border border-border">
          <div className="flex items-center gap-2 mb-2">
            <Server className="w-4 h-4 text-blue-400" />
            <span className="text-sm text-muted-foreground">Clusters</span>
          </div>
          <div className="text-2xl font-bold text-foreground">{clusters.length}</div>
        </div>

        <div className="p-4 rounded-lg bg-card/50 border border-border">
          <div className="flex items-center gap-2 mb-2">
            <Server className="w-4 h-4 text-purple-400" />
            <span className="text-sm text-muted-foreground">Nodes</span>
          </div>
          <div className="text-2xl font-bold text-foreground">{totals.nodes}</div>
        </div>

        <div className="p-4 rounded-lg bg-card/50 border border-border">
          <div className="flex items-center gap-2 mb-2">
            <Cpu className="w-4 h-4 text-blue-400" />
            <span className="text-sm text-muted-foreground">CPU Cores</span>
          </div>
          <div className="text-2xl font-bold text-foreground">{totals.cpus.toLocaleString()}</div>
        </div>

        <div className="p-4 rounded-lg bg-card/50 border border-border">
          <div className="flex items-center gap-2 mb-2">
            <MemoryStick className="w-4 h-4 text-yellow-400" />
            <span className="text-sm text-muted-foreground">Memory</span>
          </div>
          <div className="text-2xl font-bold text-foreground">{Math.round(totals.memoryGB)} GB</div>
        </div>

        {totals.gpus > 0 && (
          <div className="p-4 rounded-lg bg-card/50 border border-border">
            <div className="flex items-center gap-2 mb-2">
              <Cpu className="w-4 h-4 text-purple-400" />
              <span className="text-sm text-muted-foreground">GPUs</span>
            </div>
            <div className="text-2xl font-bold text-foreground">
              <span className="text-purple-400">{totals.gpusAllocated}</span>
              <span className="text-muted-foreground">/{totals.gpus}</span>
            </div>
          </div>
        )}
      </div>

      {/* Cluster List */}
      <div>
        <h3 className="text-lg font-semibold text-foreground mb-4">
          Clusters ({clusters.length})
        </h3>
        <div className="space-y-3">
          {clusters.map((cluster) => {
            // Calculate actual resource usage percentages from cluster data
            const cpuPercent = cluster.cpuCores && cluster.cpuRequestsCores
              ? Math.round((cluster.cpuRequestsCores / cluster.cpuCores) * 100)
              : 0
            const memoryGB = cluster.memoryGB || 0
            const memoryPercent = cluster.memoryGB && cluster.memoryRequestsGB
              ? Math.round((cluster.memoryRequestsGB / cluster.memoryGB) * 100)
              : 0
            const gpuData = clusterGPUs[cluster.name] || { total: 0, allocated: 0 }
            // Cap at 100% - allocated should never exceed total (data issue if it does)
            const rawGpuPercent = gpuData.total > 0 ? Math.round((gpuData.allocated / gpuData.total) * 100) : 0
            const gpuPercent = Math.min(rawGpuPercent, 100)

            return (
              <div
                key={cluster.name}
                onClick={() => drillToCluster(cluster.name, {
                  healthy: cluster.healthy,
                  nodeCount: cluster.nodeCount,
                  podCount: cluster.podCount,
                  cpuCores: cluster.cpuCores,
                })}
                className="p-4 rounded-lg bg-card/50 border border-border cursor-pointer hover:bg-card hover:border-primary/50 transition-colors group"
              >
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-3">
                    <StatusIndicator status={cluster.reachable === false ? 'unreachable' : cluster.healthy ? 'healthy' : 'error'} />
                    <div>
                      <div className="font-medium text-foreground">{cluster.name.split('/').pop()}</div>
                      <div className="text-xs text-muted-foreground">
                        {cluster.reachable !== false ? `${cluster.nodeCount ?? '-'} nodes â€¢ ${cluster.podCount ?? '-'} pods` : 'Cluster offline'}
                      </div>
                    </div>
                  </div>
                  <ChevronRight className="w-5 h-5 text-muted-foreground opacity-0 group-hover:opacity-100 transition-opacity" />
                </div>

                {/* Resource gauges - fixed 3-column grid for alignment */}
                <div className="grid grid-cols-3 gap-4">
                  <div className="flex flex-col items-center">
                    <Gauge
                      value={cpuPercent}
                      max={100}
                      size="sm"
                      thresholds={{ warning: 70, critical: 90 }}
                    />
                    <div className="flex items-center gap-1 mt-1">
                      <Cpu className="w-3 h-3 text-purple-400" />
                      <span className="text-xs text-muted-foreground">{cluster.cpuCores || 0}</span>
                    </div>
                  </div>

                  <div className="flex flex-col items-center">
                    <Gauge
                      value={memoryPercent}
                      max={100}
                      size="sm"
                      thresholds={{ warning: 75, critical: 90 }}
                    />
                    <div className="flex items-center gap-1 mt-1">
                      <MemoryStick className="w-3 h-3 text-blue-400" />
                      <span className="text-xs text-muted-foreground">{Math.round(memoryGB)} GB</span>
                    </div>
                  </div>

                  <div className="flex flex-col items-center">
                    {gpuData.total > 0 ? (
                      <>
                        <Gauge
                          value={gpuPercent}
                          max={100}
                          size="sm"
                          thresholds={{ warning: 80, critical: 95 }}
                        />
                        <div className="flex items-center gap-1 mt-1">
                          <Cpu className="w-3 h-3 text-purple-400" />
                          <span className="text-xs text-muted-foreground">
                            {gpuData.allocated}/{gpuData.total}
                          </span>
                        </div>
                      </>
                    ) : (
                      <div className="flex flex-col items-center justify-center h-full text-muted-foreground/50">
                        <Cpu className="w-6 h-6" />
                        <span className="text-xs mt-1">No GPUs</span>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )
          })}
        </div>
      </div>
    </div>
  )
}
