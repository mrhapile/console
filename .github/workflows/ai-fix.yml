name: AI Fix with Copilot

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to fix'
        required: true
        type: number
      issue_title:
        description: 'Issue title (optional, for display)'
        required: false
        type: string

run-name: "AI Fix #${{ github.event.inputs.issue_number || github.event.issue.number }}: ${{ github.event.inputs.issue_title || github.event.issue.title || 'Processing...' }}"

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  trigger-copilot:
    # Trigger when triage/accepted is added AND ai-fix-requested label exists, OR via manual dispatch
    if: |
      (github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'triage/accepted' && contains(github.event.issue.labels.*.name, 'ai-fix-requested')) ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Set issue number
        id: issue
        run: |
          ISSUE_NUM="${{ github.event.inputs.issue_number || github.event.issue.number }}"
          echo "number=$ISSUE_NUM" >> $GITHUB_OUTPUT

      - name: Get issue details
        id: issue_details
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_JSON=$(gh api repos/${{ github.repository }}/issues/${{ steps.issue.outputs.number }})
          echo "title=$(echo "$ISSUE_JSON" | jq -r '.title')" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_JSON" | jq -r '.body' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Add rocket reaction to issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ steps.issue.outputs.number }}/reactions \
            -X POST \
            -f content='rocket'

      - name: Update labels - processing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE="${{ steps.issue.outputs.number }}"

          # Create labels if they don't exist
          gh label create "ai-processing" --repo "$REPO" --color "fbca04" --description "AI is currently processing this issue" 2>/dev/null || true
          gh label create "ai-fix-requested" --repo "$REPO" --color "d4c5f9" --description "AI fix has been requested" 2>/dev/null || true

          # Update status: remove requested, add processing
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-fix-requested" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --add-label "ai-processing"

      - name: Trigger Copilot to fix issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.issue.outputs.number }} --repo ${{ github.repository }} --body "@copilot Please analyze this issue and create a pull request with a fix.

          **Issue:** ${{ steps.issue_details.outputs.title }}

          **Instructions:**
          1. Analyze the codebase to understand the issue
          2. Create a fix branch \`ai-fix/issue-${{ steps.issue.outputs.number }}\`
          3. Implement minimal, focused changes
          4. Open a pull request with the fix
          5. Follow existing code patterns

          **Project structure:**
          - \`/web\`: React 18 + TypeScript + Vite frontend
          - \`/pkg\`: Go backend with Fiber framework
          - \`/pkg/api\`: API handlers
          - \`/pkg/store\`: SQLite data store

          /copilot fix this issue and create a PR"

      - name: Update labels - copilot triggered
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE="${{ steps.issue.outputs.number }}"

          # Create completion label if it doesn't exist
          gh label create "ai-awaiting-copilot" --repo "$REPO" --color "6f42c1" --description "Awaiting Copilot response" 2>/dev/null || true

          # Update status: remove processing, add awaiting copilot
          gh issue edit "$ISSUE" --repo "$REPO" --remove-label "ai-processing" 2>/dev/null || true
          gh issue edit "$ISSUE" --repo "$REPO" --add-label "ai-awaiting-copilot"
